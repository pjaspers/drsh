<!DOCTYPE html>

<html>
<head>
  <title>DRSH - 0.0.3</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-meta">#!/usr/bin/env bash
</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1 id="drsh-0-0-3">DRSH - 0.0.3</h1>
<p>I’m a long time user of <a href="http://dra.sh/">Drash</a>, an iPhone app that quickly
looks up if it’s going to rain or not. I’ve asked @inferis about a Mac version
but sadly he doesn’t have the time at the moment. So to scratch my own personal
itch, and learn more about the exciting world of shell scripting:</p>
<pre><code>  DRSH - Drash <span class="hljs-keyword">for</span> the <span class="hljs-built_in">command</span> line
</code></pre><h1 id="what-does-it-do-">What does it do?</h1>
<pre><code> drsh Achel
 =&gt; ▁▁▆▇▇▇██▇▆▆▇▇▆▁▁▁▆▆▁▁▁▁▁▁ (3930 Achel, Belgium)
</code></pre><h1 id="how-do-i-install-it-">How do I install it?</h1>
<p><code>drsh</code> is a simple shell script, so drop it anywhere in your <code>$PATH</code> and you should
be ready to go. It does have two dependencies <a href="http://stedolan.github.io/jq/">jq</a> and
<a href="https://github.com/holman/spark">spark</a>, but those are simple to install.</p>
<p>(Homebrew has them both, so <code>brew install jq &amp;&amp; brew install spark</code>).</p>
<p>(Here’s to the lazy ones. The unfits. The rebels. The troublemakers. The round pegs in
the square holes:</p>
<pre><code> brew install https://gist.github.com/pjaspers/6577968/raw/2980704fbce8407ebeeb3d03f2663abba81191c6/drsh.rb
</code></pre><p>)</p>
<p>Or you could do: <code>curl -O https://raw.github.com/pjaspers/drsh/master/drsh</code> to a place
in your <code>$PATH</code>.</p>
<h1 id="what-s-missing-">What’s missing?</h1>
<ol>
<li><p>At this point in time the bars don’t actually reflect the amount of rain that will
fall, I just pass the data on to <a href="https://github.com/holman/spark">spark</a> and it
assumes that the highest number I pass in is the maximum (but max is actually 255).</p>
</li>
<li><p>International support? But since I’m probably not going to need this, send me a
patch if you need it.</p>
</li>
<li><p>Less dependencies. I’ll admit I mainly used <code>jq</code> to mess around with it, I’m pretty
sure we could ditch it and do some fancy <code>grep</code>, <code>awk</code>,<code>sed</code> and get the same results
without the dependency. Likewise for <code>spark</code>, it would be better to just show the chance
of rain if <code>spark</code> wasn’t found.</p>
</li>
<li><p>More cowbell</p>
</li>
</ol>
<p><strong>Anyhoe. On to the code!</strong></p>
<h2 id="helpers">Helpers</h2>
<p>Helper function to determine if a function is available or not.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">drsh_cmd_available</span></span>() {
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v <span class="hljs-variable">$1</span> &gt;/dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">return</span> 0
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">return</span> 1
    <span class="hljs-keyword">fi</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Checks if <a href="http://stedolan.github.io/jq/">jq</a> is available, it’s used to
parse the JSON returned from the Google API. It’s good, it’s small. But it is
a dependency, so sue me.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">drsh_jq_available</span></span>() {
    drsh_cmd_available <span class="hljs-string">"jq"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Checks if <a href="https://github.com/holman/spark">spark</a> is available, it’s used to
render the spark lines.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">drsh_spark_available</span></span>() {
    drsh_cmd_available <span class="hljs-string">"spark"</span>
}

<span class="hljs-function"><span class="hljs-title">drsh_geocode_usage</span></span>() {
    cat &lt;&lt;EOF

    USAGE:
      drsh_geocode ADDRESS

EOF
}</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Tries to lookup an address, and will spit out something like:
     drsh_geocode “Kontich”
     =&gt; 51.131279 4.44784 ‘Kontich, Belgium’</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">drsh_geocode</span></span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Display banner if no arguments given</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (( <span class="hljs-variable">$#</span> &lt; 1 ));<span class="hljs-keyword">then</span>
        drsh_geocode_usage; <span class="hljs-built_in">return</span> 1;
    <span class="hljs-keyword">fi</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Use Google for geocoding the user’s input. <a href="https://developers.google.com/maps/documentation/geocoding/">More info</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    drsh_geocode_url=<span class="hljs-string">"http://maps.googleapis.com/maps/api/geocode/json?sensor=false"</span>

    <span class="hljs-built_in">local</span> location=<span class="hljs-variable">${@:-`cat`}</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Check for <code>jq</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> drsh_jq_available; <span class="hljs-keyword">then</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Get the JSON formatted response by Google, trying to use <code>curl</code>‘s auto-
escaping.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        curl -sS -G --data-urlencode address=<span class="hljs-string">"<span class="hljs-variable">$location</span>"</span> <span class="hljs-string">"<span class="hljs-variable">${drsh_geocode_url}</span>"</span> |</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Parse out the lat, lng and formatted address and make sure it’s fitted
to be used in a shell script</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        jq -r <span class="hljs-string">'(.results[0] | [(.geometry.location | .lat,.lng), .formatted_address]) | @sh'</span>
    <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>jq not available, just dump the json response</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        curl -sS -G --data-urlencode address=<span class="hljs-string">"<span class="hljs-variable">$location</span>"</span> <span class="hljs-string">"<span class="hljs-variable">${drsh_geocode_url}</span>"</span>
    <span class="hljs-keyword">fi</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h3 id="text-helpers">Text Helpers</h3>
<p>Renders a text to display a missing dependency, takes two arguments
$1 - Name of dependency
$2 - Link to homepage of dependency</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">drsh_depenceny_text</span></span>() {
    cat &lt;&lt;EOF

    Drsh has a dependency on <span class="hljs-variable">$1</span>[0], please make sure it<span class="hljs-string">'s somewhere in your path.

    [0] $2
EOF
}

drsh_jq_dependency() { drsh_depenceny_text "jq" "http://stedolan.github.io/jq/";}
drsh_spark_dependency() { drsh_depenceny_text "spark" "https://github.com/holman/spark";}

drsh_help() {
    cat &lt;&lt;EOF

    USAGE:
      drsh [-h|--help] CITY

    EXAMPLES:
      drsh Leuven
      ▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁█▇▁▁▁▁▁▁ (Leuven, Belgium)
      echo "10to1, Kontich" | drsh
      ▆▆▇█▇▆▆▆▁▁▁▁▇▁▁▁▁▁▁▁▁▁▁▁▁ (Kontich, Belgium)
EOF
}

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h2 id="the-actual-function">The actual function</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">drsh</span></span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Now look up its coordinates</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">in</span>=$(drsh_geocode <span class="hljs-variable">$@</span>)
    <span class="hljs-keyword">if</span> [ ! -z <span class="hljs-string">"<span class="hljs-variable">$in</span>"</span> ]; <span class="hljs-keyword">then</span>
        lat=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$in</span> | cut -f1 -d <span class="hljs-string">" "</span>) <span class="hljs-comment"># Split on " " and get 1st result</span>
        lng=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$in</span> | cut -f2 -d <span class="hljs-string">" "</span>) <span class="hljs-comment"># Split on " " and get 2nd result</span>
        cty=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$in</span> | cut -f2 -d <span class="hljs-string">"'"</span>) <span class="hljs-comment"># Split on ' and get 2nd result</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Fetch data from Buienradar, they return data in this format:</p>
<pre><code>  000|22:20
  000|22:25
  ...
  084|00:20
</code></pre><p>The first part defines the amount of rain (255 is max). More info
here: <a href="http://gps.buienradar.nl/">http://gps.buienradar.nl/</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-built_in">printf</span> $(curl -LsS <span class="hljs-string">"http://gps.buienradar.nl/getrr.php?lat=<span class="hljs-variable">$lat</span>&amp;lon=<span class="hljs-variable">$lng</span>"</span> |</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>split on “|”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            cut -f1 -d <span class="hljs-string">"|"</span>                                                 |</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>parse to string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            bc                                                             |</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>create a sparkline</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            spark)</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Print looked up formatted address</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-built_in">printf</span> <span class="hljs-string">" (<span class="hljs-variable">$cty</span>)\n"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Done.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span>
        cat &lt;&lt;EOF

    Hmm. Couldn<span class="hljs-string">'t fetch the latitude and longitude.
    Internetz down?

EOF
        return 1;
    fi
}

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>If the file is being sourced, don’t run it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$BASH_SOURCE</span>"</span> == <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span> ]; <span class="hljs-keyword">then</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Display banner if needed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> { [ -z <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> ] &amp;&amp; [ -t 0 ] ; } || [ <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> = <span class="hljs-string">'-h'</span> ] || [ <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> = <span class="hljs-string">'--help'</span> ]; <span class="hljs-keyword">then</span>
        drsh_help; <span class="hljs-built_in">exit</span> 0;
    <span class="hljs-keyword">fi</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Check dependencies</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> ! drsh_jq_available; <span class="hljs-keyword">then</span> drsh_jq_dependency; <span class="hljs-built_in">exit</span> 1; <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">if</span> ! drsh_spark_available; <span class="hljs-keyword">then</span> drsh_spark_dependency; <span class="hljs-built_in">exit</span> 1; <span class="hljs-keyword">fi</span>

    drsh <span class="hljs-variable">${@:-`cat`}</span>
<span class="hljs-keyword">fi</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
